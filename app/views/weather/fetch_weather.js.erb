alert("Weather data is being updated!");

<% if @weather.is_a?(WeatherDecorator) %>
  $("#weather-container").html(`
    <div class="mt-6 p-4 bg-blue-50 rounded-lg shadow-md">
      <h2 class="text-lg font-semibold text-gray-800">Weather for <%= j @weather.name.to_s %></h2>
      <p>Temperature: <%= j @weather.temperature.to_s %>Â°C</p>
      <p>High: <%= j @weather.max_temp.to_s %>Â°C</p>
      <p>Low: <%= j @weather.min_temp.to_s %>Â°C</p>
      <p>Condition: <%= j @weather.condition.to_s.capitalize %></p>
      <p class="text-sm text-gray-500 mt-2">Data Source: <%= @cached ? "Cache" : "Live API" %></p>
    </div>

    <%# âœ… Existing Extended Forecast Section (Unchanged) %>
    <% if @weather.instance_variable_get(:@weather)[:forecast].present? %>
      <div class="mt-6">
        <h3 class="text-md font-semibold text-gray-800 mb-2">Forecast Data (Raw Entries):</h3>
        <div class="grid grid-cols-1 gap-2">
          <% @weather.instance_variable_get(:@weather)[:forecast].each do |day| %>
            <div class="p-3 bg-gray-100 rounded-lg shadow-sm">
              <p class="font-medium"><%= j day[:time] %></p>
              <p>Temp: <%= j day[:temp].to_s %>Â°C</p>
              <p>Condition: <%= j day[:condition].capitalize %></p>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  `);
<% else %>
  $("#weather-container").html(`
    <p style='color:red;'>Error: <%= j(@weather[:error].to_s || 'Could not fetch weather data') %></p>
    <p>Debug Info: <%= j @weather.inspect.to_s %></p>
  `);
<% end %>

<%# âœ… APPEND THIS CODE â€” FIXED FOR item.time instead of item.date %>
<% if @weather.respond_to?(:forecast) && @weather.forecast.present? %>
  const forecastData = <%= raw @weather.forecast.to_json %>;

  // Group entries by date (using item.time)
  const dailyData = {};
  forecastData.forEach(item => {
    const date = item.time.split(" ")[0]; // ðŸ‘ˆ FIXED HERE
    if (!dailyData[date]) {
      dailyData[date] = { temps: [], conditions: [] };
    }
    dailyData[date].temps.push(item.temp);
    dailyData[date].conditions.push(item.condition);
  });

  let extendedForecastHTML = `
    <h3 style="margin-top:25px;font-weight:bold;font-size:1.1rem;">ðŸ“… 5-Day Forecast Summary</h3>
    <table style="width:100%;border-collapse:collapse;margin-top:10px;">
      <thead>
        <tr style="background:#f3f4f6;text-align:left;">
          <th style="padding:8px;border:1px solid #ddd;">Date</th>
          <th style="padding:8px;border:1px solid #ddd;">Avg Temp (Â°C)</th>
          <th style="padding:8px;border:1px solid #ddd;">Condition</th>
        </tr>
      </thead>
      <tbody>
  `;

  Object.entries(dailyData).slice(0,5).forEach(([date, data]) => {
    const avgTemp = (data.temps.reduce((a,b)=>a+b,0)/data.temps.length).toFixed(1);
    const mainCondition = data.conditions[0];
    extendedForecastHTML += `
      <tr>
        <td style="padding:8px;border:1px solid #ddd;">${new Date(date).toDateString()}</td>
        <td style="padding:8px;border:1px solid #ddd;text-align:center;">${avgTemp}</td>
        <td style="padding:8px;border:1px solid #ddd;text-transform:capitalize;">${mainCondition}</td>
      </tr>
    `;
  });

  extendedForecastHTML += "</tbody></table>";

  // âœ… Append to weather container (below existing forecast)
  $("#weather-container").append(extendedForecastHTML);
<% end %>
